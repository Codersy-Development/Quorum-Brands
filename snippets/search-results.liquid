{% liquid
  assign resources = predictive_search.resources
  assign columnCount = resources.queries.size | plus: resources.pages.size | plus: resources.articles.size | plus: resources.collections.size
  assign totalCount = resources.queries.size | plus: resources.pages.size | plus: resources.articles.size | plus: resources.collections.size | plus: resources.products.size
%}

{%- if predictive_search.performed -%}
  <div class="predictive-search-results {% if totalCount == 0 %}predictive-search-results--none{% endif %}" id="predictive-search-results">
    {% if totalCount > 0 %}
      <div class="results__group-1" {% if columnCount == 0 %}style="display: none"{% endif %}>
        {%- if predictive_search.resources.queries.size > 0 -%}
          <div class="results results--queries">
            <h3 class="h4" id="predictive-search-suggestions">
              {{ 'general.search.suggestions' | t }}
            </h3>
            <ul role="listbox" aria-labelledby="predictive-search-queries">
              {%- for query in predictive_search.resources.queries -%}
                <li role="option">
                  <a href="{{ query.url }}">
                    <span>{{ query.styled_text }}</span>
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
        {%- if predictive_search.resources.pages.size > 0 -%}
          <div class="results results--pages">
            <h3 class="h4" id="predictive-search-pages">
              {{ 'general.search.pages' | t }}
            </h3>
            <ul role="listbox" aria-labelledby="predictive-search-pages">
              {%- for page in predictive_search.resources.pages -%}
                <li role="option">
                  <a href="{{ page.url }}">
                    <span>{{ page.title }}</span>
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
        {%- if predictive_search.resources.articles.size > 0 -%}
          <div class="results results--articles">
            <h3 class="h4" id="predictive-search-articles">
              {{ 'general.search.articles' | t }}
            </h3>
            <ul role="listbox" aria-labelledby="predictive-search-articles">
              {%- for article in predictive_search.resources.articles -%}
                <li role="option">
                  <a href="{{ article.url }}">
                    <span>{{ article.title }}</span>
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
        {%- if predictive_search.resources.collections.size > 0 -%}
          <div class="results results--collections">
            <h3 class="h4" id="predictive-search-collections">
              {{ 'general.search.collections' | t }}
            </h3>
            <ul role="listbox" aria-labelledby="predictive-search-collections">
              {%- for collection in predictive_search.resources.collections -%}
                <li role="option">
                  <a href="{{ collection.url }}">
                    <span>{{ collection.title }}</span>
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
      </div>

      <div class="results__group-2">
        {%- if predictive_search.resources.products.size > 0 -%}
          <div class="results results--products">
            <h3 class="h4" id="predictive-search-products">
              {{ 'general.search.products' | t }}
            </h3>
            <ul role="listbox" aria-labelledby="predictive-search-products" id="predictive-products-list">
              {%- for product in predictive_search.resources.products -%}
                <li role="option" class="predictive-product-item" data-vendor="{{ product.vendor | downcase }}">
                  <a href="{{ product.url }}">
                    <div class="results-products__image grid__image-ratio">
                      {% if product.media != blank %}
                        {%- render 'image-element',
                          img: product.featured_media,
                          widths: '80, 160, 240',
                        -%}
                      {% endif %}
                    </div>
                    <div class="results-products__info">
                      <span>{{ product.title }}</span>
                      {% if settings.predictive_search_show_vendor %}
                      <span class="grid-product__vendor">{{ product.vendor }}</span>
                      {% endif %}
                      {% if settings.predictive_search_show_price %}
                        {%- if on_sale -%}
                          <span class="visually-hidden">{{ 'products.general.regular_price' | t }}</span>
                          <span class="grid-product__price--original">{{ product.compare_at_price | money }}</span>
                          <span class="visually-hidden">{{ 'products.general.sale_price' | t }}</span>
                        {%- endif -%}

                        {%- if product.price_varies -%}
                          {%- assign price = product.price_min | money -%}
                          <span class="grid-product__price">{{ 'products.general.from_text_html' | t: price: price }}</span>
                        {%- else -%}
                          <span class="grid-product__price">{{ product.price | money }}</span>
                        {%- endif -%}
                        {%- if on_sale -%}
                          {%- if settings.product_save_amount -%}
                            {%- if settings.product_save_type == 'dollar' -%}
                              {%- capture saved_amount -%}{{ product.compare_at_price | minus: product.price | money }}{%- endcapture -%}
                            {%- else -%}
                              {%- capture saved_amount -%}{{ product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round }}%{%- endcapture -%}
                            {%- endif -%}
                            <span class="grid-product__price--savings">
                              {{ 'products.general.save_html' | t: saved_amount: saved_amount }}
                            </span>
                          {%- endif -%}
                        {%- endif -%}
                      {% endif %}
                    </div>

                  </a>
                </li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
        {%- if predictive_search.resources.pages.size > 0 -%}
          <div class="results results--pages">
            <h3 class="h4" id="predictive-search-pages">
              {{ 'general.search.pages' | t }}
            </h3>
            <ul role="listbox" aria-labelledby="predictive-search-pages">
              {%- for page in predictive_search.resources.pages -%}
                <li role="option">
                  <a href="{{ page.url }}">
                    <span>{{ page.title }}</span>
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
        {%- if predictive_search.resources.articles.size > 0 -%}
          <div class="results results--articles">
            <h3 class="h4" id="predictive-search-articles">
              {{ 'general.search.articles' | t }}
            </h3>
            <ul role="listbox" aria-labelledby="predictive-search-articles">
              {%- for article in predictive_search.resources.articles -%}
                <li role="option">
                  <a href="{{ article.url }}">
                    <span>{{ article.title }}</span>
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
        {%- if predictive_search.resources.collections.size > 0 -%}
          <div class="results results--collections">
            <h3 class="h4" id="predictive-search-collections">
              {{ 'general.search.collections' | t }}
            </h3>
            <ul role="listbox" aria-labelledby="predictive-search-collections">
              {%- for collection in predictive_search.resources.collections -%}
                <li role="option">
                  <a href="{{ collection.url }}">
                    <span>{{ collection.title }}</span>
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
      </div>
    {% else %}
      <div class="results"><a class="predictive-search__no-results" href="{{ routes.search_url }}?q={{ predictive_search.terms | escape }}">{{ 'general.search.no_results_html' | t: terms: predictive_search.terms }}</a></div>
    {% endif %}
  </div>
  {% if totalCount > 0 %}
    <button class="results__search-btn">
      {{ 'general.search.view_more' | t: terms: predictive_search.terms }} <svg width="14" height="10" viewBox="0 0 14 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 5H12.5M12.5 5L8.5 1M12.5 5L8.5 9" stroke="currentColor"/></svg>
    </button>
  {% endif %}
{%- endif -%}

{% unless request.design_mode %}
<script>
  // Filter predictive search results based on selected store
  function filterPredictiveSearchResults() {
    const selectedStore = localStorage.getItem("store-selected") || "";
    const productItems = document.querySelectorAll('.predictive-product-item');
    
    console.log('=== FILTERING PREDICTIVE SEARCH RESULTS ===');
    console.log('Selected store:', selectedStore);
    console.log('Product items found:', productItems.length);
    
    let visibleCount = 0;
    let hiddenCount = 0;
    
    productItems.forEach((item, index) => {
      const productVendor = item.dataset.vendor || "";
      
      // Allow products to show when "Shop All Brands" is selected
      const shouldShow = selectedStore.toLowerCase().includes("shop all") || 
                        productVendor.toLowerCase() === selectedStore.toLowerCase();
      
      if (shouldShow) {
        item.style.display = '';
        visibleCount++;
        console.log(`✓ Showing product ${index + 1} (vendor: ${productVendor})`);
      } else {
        item.style.display = 'none';
        hiddenCount++;
        console.log(`✗ Hiding product ${index + 1} (vendor: ${productVendor})`);
      }
    });
    
    console.log(`Results: ${visibleCount} visible, ${hiddenCount} hidden`);
    
    // Update the products section visibility
    const productsSection = document.querySelector('.results--products');
    if (productsSection) {
      if (visibleCount === 0) {
        productsSection.style.display = 'none';
        console.log('Hiding entire products section - no matching products');
      } else {
        productsSection.style.display = '';
        console.log('Showing products section');
      }
    }
    
    // Update the results count if needed
    updateResultsCount();
  }
  
  function updateResultsCount() {
    // Update total count display if you have one
    const visibleProducts = document.querySelectorAll('.predictive-product-item:not([style*="display: none"])');
    console.log('Updated visible product count:', visibleProducts.length);
  }
  
  // Filter results when page loads
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(filterPredictiveSearchResults, 100);
  });
  
  // Filter results when predictive search results update
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList' && 
          mutation.target.id === 'predictive-search-results') {
        console.log('Predictive search results updated, re-filtering...');
        setTimeout(filterPredictiveSearchResults, 50);
      }
    });
  });
  
  // Start observing changes to predictive search results
  const searchResults = document.getElementById('predictive-search-results');
  if (searchResults) {
    observer.observe(searchResults, { childList: true, subtree: true });
  }
  
  // Listen for store changes and re-filter
  document.addEventListener('change', function(e) {
    if (e.target.matches('store-switcher input[type="radio"]') || 
        (e.target.type === 'radio' && e.target.closest('store-switcher')) ||
        (e.target.type === 'radio' && e.target.name && e.target.name.startsWith('store-switcher-'))) {
      
      console.log('Store changed, re-filtering predictive search results...');
      setTimeout(filterPredictiveSearchResults, 100);
    }
  });
</script>
{% endunless %}