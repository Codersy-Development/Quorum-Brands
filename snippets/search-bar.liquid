{%- unless search_btn_style -%}
  {%- assign search_btn_style = 'btn' -%}
{%- endunless -%}
<form action="{{ routes.search_url }}" method="get" class="input-group search-bar {{ search_bar_location }}" role="search">
  <label for="search-bar-icon" class="hidden-label">{{ 'general.search.submit' | t }}</label>
  <input type="hidden" name="type" value="{{ settings.search_type }}">
  <input type="hidden" name="options[prefix]" value="last">
  <input type="search" name="q" value="{{ search.terms | escape | replace: '*', '' }}" placeholder="{{ 'general.search.placeholder' | t }}" class="input-group-field" aria-label="{{ 'general.search.placeholder' | t }}">
  <div class="input-group-btn">
    <button type="submit" id="search-bar-icon" class="{{ search_btn_style }}">
      <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-search" viewBox="0 0 64 64"><title>icon-search</title><path d="M47.16 28.58A18.58 18.58 0 1 1 28.58 10a18.58 18.58 0 0 1 18.58 18.58ZM54 54 41.94 42"/></svg>
      <span class="icon__fallback-text">{{ 'general.search.submit' | t }}</span>
    </button>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let selectedStore = '';

  console.log('=== STORE SWITCHER DEBUG SCRIPT LOADED ===');

  // Debug: Check what elements exist
  setTimeout(function() {
    const storeSwitcher = document.querySelector('store-switcher');
    const storeRadios = document.querySelectorAll('store-switcher input[type="radio"]');
    const vendorCheckboxes = document.querySelectorAll('input[name="filter.p.vendor"]');
    
    console.log('Store switcher element found:', !!storeSwitcher);
    console.log('Store radio buttons found:', storeRadios.length);
    console.log('Vendor filter checkboxes found:', vendorCheckboxes.length);
    
    // More specific debugging for your store switcher structure
    const allStoreRadios = document.querySelectorAll('input[name^="store-switcher-"]');
    console.log('Store radios with dynamic names found:', allStoreRadios.length);
    
    storeRadios.forEach((radio, index) => {
      console.log(`Radio ${index + 1}:`, radio.value, 'checked:', radio.checked, 'name:', radio.name, 'id:', radio.id);
    });
    
    allStoreRadios.forEach((radio, index) => {
      console.log(`Dynamic name radio ${index + 1}:`, radio.value, 'checked:', radio.checked, 'name:', radio.name);
    });
    
    vendorCheckboxes.forEach((checkbox, index) => {
      console.log(`Vendor checkbox ${index + 1}:`, checkbox.value, 'checked:', checkbox.checked);
    });
  }, 500);

  // Function to get selected store from store switcher
  function getSelectedStore() {
    // Try multiple approaches to find the selected store
    
    // Approach 1: Look for checked radio within store-switcher
    const checkedStoreRadio = document.querySelector('store-switcher input[type="radio"]:checked');
    if (checkedStoreRadio) {
      console.log('âœ“ Found selected store (approach 1):', checkedStoreRadio.value);
      return checkedStoreRadio.value;
    }
    
    // Approach 2: Look for checked radio with dynamic store-switcher name
    const checkedDynamicRadio = document.querySelector('input[name^="store-switcher-"]:checked');
    if (checkedDynamicRadio) {
      console.log('âœ“ Found selected store (approach 2):', checkedDynamicRadio.value);
      return checkedDynamicRadio.value;
    }
    
    // Approach 3: If all are checked (your current setup), get the last one clicked
    const allStoreRadios = document.querySelectorAll('input[name^="store-switcher-"]');
    if (allStoreRadios.length > 0) {
      // Find the most recently interacted radio or use a different approach
      console.log('Found', allStoreRadios.length, 'store radios, checking which one was last clicked');
      
      // For now, return the first one as fallback
      console.log('âœ“ Using first store radio as fallback:', allStoreRadios[0].value);
      return allStoreRadios[0].value;
    }
    
    console.log('âœ— No selected store found');
    return '';
  }

  // Function to check/uncheck vendor filter based on selected store
  function updateVendorFilter() {
    selectedStore = getSelectedStore();
    console.log('=== UPDATING VENDOR FILTER ===');
    console.log('Selected store:', selectedStore);
    
    if (selectedStore) {
      // Uncheck ALL vendor filters first (handle duplicates)
      const vendorCheckboxes = document.querySelectorAll('input[name="filter.p.vendor"]');
      console.log('Found', vendorCheckboxes.length, 'vendor checkboxes to uncheck');
      
      vendorCheckboxes.forEach((checkbox, index) => {
        checkbox.checked = false;
        console.log(`Unchecked vendor checkbox ${index + 1}:`, checkbox.value);
      });

      // Check ALL vendor filters that match the selected store (handle duplicates)
      const capitalizedStore = selectedStore.charAt(0).toUpperCase() + selectedStore.slice(1);
      const targetVendorCheckboxes = document.querySelectorAll(`input[name="filter.p.vendor"][value="${capitalizedStore}"]`);
      
      console.log(`Looking for vendor checkboxes with value "${capitalizedStore}"`);
      console.log(`Found ${targetVendorCheckboxes.length} matching vendor checkboxes`);
      
      targetVendorCheckboxes.forEach((checkbox, index) => {
        checkbox.checked = true;
        console.log(`âœ“ Checked vendor filter ${index + 1} for:`, capitalizedStore);
        
        // Trigger multiple types of events to ensure filtering system responds
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        checkbox.dispatchEvent(new Event('input', { bubbles: true }));
        checkbox.dispatchEvent(new Event('click', { bubbles: true }));
        console.log(`âœ“ Triggered change/input/click events on checkbox ${index + 1}`);
      });
      
      // Try to trigger any filter update functions that might exist
      setTimeout(function() {
        // Look for common filter update functions
        if (window.updateFilters && typeof window.updateFilters === 'function') {
          console.log('Calling window.updateFilters()');
          window.updateFilters();
        }
        
        if (window.applyFilters && typeof window.applyFilters === 'function') {
          console.log('Calling window.applyFilters()');
          window.applyFilters();
        }
        
        // Look for filter forms and trigger submission
        const filterForm = document.querySelector('form[action*="search"], form.filter-form, .search-form form');
        if (filterForm) {
          console.log('Found filter form, triggering update...');
          // Trigger form change event
          filterForm.dispatchEvent(new Event('change', { bubbles: true }));
          
          // If nothing else works, uncomment this to force form submission:
          // filterForm.requestSubmit();
        }
        
        // Look for search/filter buttons and click them
        const filterButton = document.querySelector('button[type="submit"]');
        if (filterButton && filterButton.closest('form')) {
          console.log('Found filter submit button, considering click...');
          // Uncomment if you want to auto-submit:
          // filterButton.click();
        }
      }, 100);
    }
    console.log('=== VENDOR FILTER UPDATE COMPLETE ===');
  }

  // Function to update search placeholder
  function updateSearchPlaceholder() {
    const searchInputs = document.querySelectorAll('input[type="search"][name="q"]');
    const capitalizedStore = selectedStore ? selectedStore.charAt(0).toUpperCase() + selectedStore.slice(1) : '';
    
    console.log('Updating', searchInputs.length, 'search input placeholders');
    
    searchInputs.forEach((input, index) => {
      if (selectedStore) {
        input.placeholder = `Search ${capitalizedStore} products...`;
        console.log(`Updated search input ${index + 1} placeholder to: Search ${capitalizedStore} products...`);
      } else {
        input.placeholder = "{{ 'general.search.placeholder' | t }}";
      }
    });
  }

  // Listen for ALL change events and log them
  document.addEventListener('change', function(e) {
    console.log('=== CHANGE EVENT DETECTED ===');
    console.log('Element that changed:', e.target);
    console.log('Element type:', e.target.type);
    console.log('Element name:', e.target.name);
    console.log('Element value:', e.target.value);
    console.log('Is inside store-switcher:', !!e.target.closest('store-switcher'));
    
    // Check if the changed element is a store switcher radio
    if (e.target.matches('store-switcher input[type="radio"]') || 
        (e.target.type === 'radio' && e.target.closest('store-switcher'))) {
      
      console.log('ðŸŽ¯ STORE SWITCHER RADIO CHANGED!');
      selectedStore = e.target.value;
      console.log('New selected store:', selectedStore);
      
      // Update vendor filter and search placeholder
      updateVendorFilter();
      updateSearchPlaceholder();
      
      // Store selected store for persistence
      localStorage.setItem('selectedStore', selectedStore);
      console.log('Stored in localStorage:', selectedStore);
    }
    
    // Also log vendor checkbox changes
    if (e.target.name === 'filter.p.vendor') {
      console.log('ðŸ“¦ VENDOR FILTER CHANGED:', e.target.value, 'checked:', e.target.checked);
    }
  });

  // More aggressive approach - listen for clicks on store switcher labels
  document.addEventListener('click', function(e) {
    console.log('=== CLICK EVENT DETECTED ===');
    console.log('Clicked element:', e.target);
    
    // Check if clicking on store switcher label or radio
    const storeLabel = e.target.closest('store-switcher label');
    const storeRadio = e.target.closest('store-switcher input[type="radio"]');
    
    if (storeLabel || storeRadio) {
      console.log('ðŸŽ¯ STORE SWITCHER CLICKED!');
      
      // Find the associated radio button
      let targetRadio = null;
      if (storeLabel) {
        const forAttr = storeLabel.getAttribute('for');
        targetRadio = document.getElementById(forAttr);
      } else if (storeRadio) {
        targetRadio = storeRadio;
      }
      
      if (targetRadio) {
        console.log('Target radio found:', targetRadio.value);
        
        // Wait a moment for the radio to be checked, then update
        setTimeout(function() {
          selectedStore = targetRadio.value;
          console.log('Updating to store:', selectedStore);
          updateVendorFilter();
          updateSearchPlaceholder();
          localStorage.setItem('selectedStore', selectedStore);
        }, 50);
      }
    }
  });

  // Polling approach as backup - check for store changes every 500ms
  let lastSelectedStore = '';
  setInterval(function() {
    const currentStore = getSelectedStore();
    if (currentStore !== lastSelectedStore && currentStore !== '') {
      console.log('ðŸ”„ POLLING DETECTED STORE CHANGE:', lastSelectedStore, 'â†’', currentStore);
      selectedStore = currentStore;
      lastSelectedStore = currentStore;
      updateVendorFilter();
      updateSearchPlaceholder();
      localStorage.setItem('selectedStore', selectedStore);
    }
  }, 500);

  // Initialize with selected store
  setTimeout(function() {
    console.log('=== INITIALIZING ===');
    selectedStore = getSelectedStore();
    if (selectedStore) {
      console.log('Initializing with store:', selectedStore);
      updateVendorFilter();
      updateSearchPlaceholder();
    } else {
      console.log('No store selected during initialization');
    }
  }, 300);
});
</script>