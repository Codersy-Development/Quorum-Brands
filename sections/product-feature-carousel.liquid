{{ 'custom-product-slider-carousel.css' | asset_url | stylesheet_tag }}
<section
    class="product-feature-carousel room-feature"
    {% unless section.settings.store == "all" %}
        data-store="{{ section.settings.store }}"
    {% endunless %}
>
    <div class="container">
        <div class="feature-grid">
            <div class="feature-left">
                {% assign first_block = section.blocks[0] %}
                {% if first_block.settings.product_url %}
                    <a href="{{ first_block.settings.product_url }}" target="_blank" rel="noopener" class="main-image-link">
                        <img id="mainImageDynamic" src="{{ first_block.settings.main_image | img_url: 'master' }}" alt="Main Room Image" class="main-image fade-in">
                    </a>
                {% else %}
                    <img id="mainImageDynamic" src="{{ first_block.settings.main_image | img_url: 'master' }}" alt="Main Room Image" class="main-image fade-in">
                {% endif %}
            </div>

            <div class="feature-right">
                <div class="feature-card">
                    <div class="card-swiper swiper">
                        <div class="swiper-wrapper">
                            {% for block in section.blocks %}
                                <div class="swiper-slide" 
                                     data-main-image="{{ block.settings.main_image | img_url: 'master' }}"
                                     data-product-url="{{ block.settings.product_url }}">
                                    {% if block.settings.card_image %}
                                        {% if block.settings.product_url %}
                                            <a href="{{ block.settings.product_url }}" target="_blank" rel="noopener" class="card-image-link">
                                                <img src="{{ block.settings.card_image | img_url: 'master' }}" alt="Slide Image" class="card-image">
                                            </a>
                                        {% else %}
                                            <img src="{{ block.settings.card_image | img_url: 'master' }}" alt="Slide Image" class="card-image">
                                        {% endif %}
                                    {% endif %}
                                    {% if block.settings.heading %}
                                        <h2 class="card-title">{{ block.settings.heading }}</h2>
                                    {% endif %}
                                    {% if block.settings.text %}
                                        <p class="card-text">{{ block.settings.text }}</p>
                                    {% endif %}
                                    {% if block.settings.button_label and block.settings.button_link %}
                                        <a href="{{ block.settings.button_link }}" class="card-button">{{ block.settings.button_label }}</a>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <div class="product-button-wrapper">
                            <div class="product-button-prev">
                                <img src="{{ 'ico-arrow-right.svg' | asset_url }}" alt="Icon">
                            </div>
                            <div class="product-button-next">
                                <img src="{{ 'ico-arrow-right.svg' | asset_url }}" alt="Icon">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css" />
<script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>

<style>
.main-image-link, .card-image-link {
    display: block;
    cursor: pointer;
    transition: opacity 0.3s ease;
}

.main-image-link:hover, .card-image-link:hover {
    opacity: 0.9;
}

.card-image-link {
    margin-bottom: 1rem;
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const mainImage = document.getElementById('mainImageDynamic');
        const mainImageContainer = document.querySelector('.feature-left');

        const swiper = new Swiper('.card-swiper', {
            slidesPerView: 1,
            navigation: {
                nextEl: '.product-button-next',
                prevEl: '.product-button-prev',
            },
            loop: false,
            on: {
                slideChange: function () {
                    const currentSlide = swiper.slides[swiper.activeIndex];
                    const newSrc = currentSlide.getAttribute('data-main-image');
                    const newProductUrl = currentSlide.getAttribute('data-product-url');

                    if (newSrc && mainImage.src !== newSrc) {
                        // Hide before changing src
                        mainImage.classList.remove('visible');

                        // Wait for image to fully load before showing again
                        const onLoadHandler = () => {
                            mainImage.classList.add('visible');
                            mainImage.removeEventListener('load', onLoadHandler);
                        };

                        mainImage.addEventListener('load', onLoadHandler);
                        mainImage.src = newSrc;

                        // Update the main image link
                        const existingLink = mainImageContainer.querySelector('.main-image-link');
                        
                        if (newProductUrl) {
                            if (existingLink) {
                                // Update existing link
                                existingLink.href = newProductUrl;
                            } else {
                                // Create new link wrapper
                                const link = document.createElement('a');
                                link.href = newProductUrl;
                                link.target = '_blank';
                                link.rel = 'noopener';
                                link.className = 'main-image-link';
                                
                                // Wrap the image
                                mainImage.parentNode.insertBefore(link, mainImage);
                                link.appendChild(mainImage);
                            }
                        } else {
                            if (existingLink) {
                                // Remove link wrapper, keep image
                                const parent = existingLink.parentNode;
                                parent.insertBefore(mainImage, existingLink);
                                parent.removeChild(existingLink);
                            }
                        }
                    }
                }
            }
        });

        // Initial load fade-in
        if (mainImage.complete) {
            requestAnimationFrame(() => mainImage.classList.add('visible'));
        } else {
            mainImage.addEventListener('load', () => {
                requestAnimationFrame(() => mainImage.classList.add('visible'));
            });
        }
    });
</script>

{% schema %}
{
  "name": "Product Feature Carousel",
  "tag": "section",
  "class": "room-feature-carousel",
  "settings": [
    {
      "type": "select",
      "id": "store",
      "label": "Store",
      "info": "Populate this to show only on specific store",
      "options": [
        { "value": "all", "label": "Show On Both" },
        { "value": "shop all brands", "label": "Shop All Brands" },
        { "value": "quorum", "label": "Quorum" },
        { "value": "oxygen", "label": "Oxygen" }
      ],
      "default": "all"
    }
  ],
  "blocks": [
    {
      "type": "card_slide",
      "name": "Card Slide",
      "settings": [
        {
          "type": "image_picker",
          "id": "main_image",
          "label": "Main Large Image"
        },
        {
          "type": "image_picker",
          "id": "card_image",
          "label": "Card Image"
        },
        {
          "type": "url",
          "id": "product_url",
          "label": "Product URL",
          "info": "Make both images clickable - opens in new tab"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading Text",
          "default": "Shop by Room: Dining"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "Paragraph Text",
          "default": "Designed to enhance every meal, our dining selection combines timeless style with thoughtful functionality."
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button Label",
          "default": "Explore Products"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Button Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Feature Carousel"
    }
  ]
}
{% endschema %}